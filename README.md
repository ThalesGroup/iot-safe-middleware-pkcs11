# Introduction

This project is a project for PKCS#11 provider implementation.

This PKCS#11 provider conforms the v2.40.

Refer to the below references for further technical specification on PKCS#11:
- PKCS#11 v2.40

  https://docs.oasis-open.org/pkcs11/pkcs11-base/v2.40/errata01/os/pkcs11-base-v2.40-errata01-os-complete.html

- PKCS#11 v3.0

  https://docs.oasis-open.org/pkcs11/pkcs11-base/v3.0/os/pkcs11-base-v3.0-os.html

The token for this PKCS#11 provider project is a Secure Element that hosts IoTSAFE smartcard applet.

Since the Secure Element hosts a smartcard applet, most of the time, the SE is some form-factor of an ICC.

Several popular ICC form factors are:
- ID-1 form-factor, aka smartcard
- Mini / micro / nano SIM card
- eSIM
- iSIM

This PKCS#11 provider implementation in fact, does not care about the ICC form-factor; It only cares about the hardware interface between the PC and the ICC containing the smartcard applet.

The current SE hardware interfaces supported for this PKCS#11 provider implementation are:
- Modem

  Suitable for mini / micro / nano SIM card.

# Prepare this repository

```
git submodule init
git submodule update
```



# Building and Installing

This PKCS#11 provider implementation will by default, communicate with a "/dev/ttyACM0" device.

To update the correct path to a SE hardware interface device, update the following file:
- se-pkcs11-lib/Cardmanager.cpp

  ```
  #define STR_CINTERION_MODEM_NAME "/dev/ttyACM0"
  ```

To build and install the PKCS#11 provider:
```
./project-build.sh Release
```

This will build a release version of the PKCS#11 provider, a modem library used by the PKCS#11 provider, and several test suites in the `binaries/Release/` from the root directory of this project.

The PKCS#11 provider will be built in the `binaries/Release/libgtosepkcs11`, and will be installed as the `/usr/local/lib/libgtosepkcs11.so`.

The modem library will be built in the `binaries/Release/libcinmodem_access`, and will be installed as the `/usr/local/lib/libcinmodem_access.so`.

The test suites will be built in the `binaries/Release/*-test`.

Lastly, a configuration file for the PKCS#11 provider will be installed as the `/etc/IDGo800/Gemalto.PKCS11.ini` file.

The following are other types of building the project:
- Building with debug suitable for gdb.

  ```
  ./project-build.sh Debug
  ```
  
  The build will be located at `binaries/Debug`.
  
- Building with code coverage suitable for gcov.

  ```
  ./project-build.sh CodeCoverage
  ```
  
  The build will be located at `binaries/CodeCoverage`.
  
  The required files for gcov (`*.gcno`, `*.gcda`, and source files) will be placed in `binaries/CodeCoverage/libgtosepkcs11` and `binaries/CodeCoverage/libcinmodem_access`.
  
  Note that the `*.gcda` files can be generated by running the PKCS#11 provider installed as the `/usr/local/lib/libgtosepkcs11.so`.
  
- Building with code profiling with gprof.

  ```
  ./project-build.sh CodeProfile
  ```
  
The build will be located at `binaries/CodeProfile`.
  
The required files for gprof (`gmon*` and object files) will be placed in `binaries/CodeProfile/libgtosepkcs11` and `binaries/CodeProfile/libcinmodem_access`.
  
Note that the `gmon*` files can be generated by running the PKCS#11 provider installed as the `/usr/local/lib/libgtosepkcs11.so`.

# Configuration File

The PKCS#11 provider configuration file will be installed as the `/etc/IDGo800/Gemalto.PKCS11.ini` file.

The content of the configuration file is self-documented.

Below are the short descriptions of each configuration variables:
- Enable

  Set this variable to 0 to disable logging to stdout and stderr.

  Set this variable to 1 to enable logging to stdout and stderr.

- Path

  Set this field to an additional file to output logs.

- Apdu

  Set this variable to 0 to disable tracing non-sensitive APDU in the log.

  Set this variable to 1 to enable tracing non-sensitive APDU in the log.

- Enable

  Set this variable to 0 to disable caching to secodary storage.

  Set this variable to 1 to enable caching to secodary storage.

  This variable is ignored for now.

- ForcePinUser = 1

  Set this variable to 0 to disable forcing generated keys to be associated to PIN User.

  Set this variable to 1 to enable forcing generated keys to be associated to PIN User.

- HideStaticSlots

  Set this variable to 0 to not hide virtual slots for cards with static profile.

  Set this variable to 1 to hide virtual slots for cards with static profile.

- DisableCertificateValidation

  Set this variable to 0 to default validation of all certificate attributes.

  Set this variable to 1 to validation of CKA_ISSUER and CKA_SUBJECT or 0 to default validation of all certificate attributes.

- PIN_*

  PINs used for the PKCS#11 provider.

  This variable is ignored for now.

# Running Tests

To run the PKCS#11 provider test, first go to `binaries/release/pkcs11-test` from the root directory of this project, then run the pkcs11-test executable found in this directory.

The printed help usage of the test is as follow:
```
(c)2021 Thales Development
            usage:  program  [Options]

 Options

      -p:<pincode>                     pin value
      -i:<slotid>                      slot id value
      -l:<cryptoki/library/path>       cryptoki library path
      -f                               Prints all the objects and their
                                       attributes in the token.
      -R                               Remove all objects from the token.
      -r:<id>                          Remove object identified by id from
                                       the token.
      -k:<algo:length:id>              Generate a new key pair public
                                       private pair and aes key.
                                       for example -k:rsa:1024 -k:aes:128.
      -s:<algo:id:data>                Signature with verification
                                       Sign data using a private key identified by id.
                                       Verify the sgnature using the related public key
                                       Example : -s:rsa:keyid:data -s:ec:keyid:data
      -e:<algo:id:data>                Encryption / decryption
                                       Encrypt plain text data using a public key identified by id
                                       Decrypt the encrypted data using the private key to get the plain text data
                                       Example : -e:rsa:keyid of pubk -e:aes:keyid
      -c                               Perform AES CMAC 128-bit signature.      -g                               Random generation 8 bytes.
      -a:<nb tests>                    Perform nb iteration of all tests.

      -h                               Perform a Diffie-Hellman.

      All arguments are optional. Defaults are:
                <pincode>
                <slotid> 0
                <cryptokidll> /usr/local/lib/libgtosepkcs11.so
the main test is located in:
```

Below are the examples on how to run the test:
- To test generating a random number:

  ```
  ./pkcs11-test -p:1234 -i:0 -p:0000 -g
  ```

- To test signing and verifying an ECDSA signature:

  ```
  ./pkcs11-test -p:1234 -i:0 -p:0000 -s:ecc:01:hello
  ```

- To test performing ECDHE:

  ```
  ./pkcs11-test -p:1234 -i:0 -l:/usr/local/lib/libgtosepkcs11.so -h
  ```
  -l is optional

- To test performing AES CMAC:

  ```
  ./pkcs11-test -p:1234 -i:0 -l:/usr/local/lib/libgtosepkcs11.so -c
  ```
  -l is optional

# Other Related Projects

This PKCS#11 library could be integrated with other projects mentioned below:
- https://github.com/p11-glue/p11-kit
- https://github.com/OpenSC/libp11
- https://www.gnutls.org/manual/html_node/PKCS11-Initialization.html
- https://botan.randombit.net/handbook/api_ref/pkcs11.html
